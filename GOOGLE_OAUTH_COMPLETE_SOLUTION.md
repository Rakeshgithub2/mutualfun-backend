# üîê Google OAuth Complete Solution

## ‚úÖ What's Working in Your Backend

Your backend is **correctly configured** for Google OAuth! Here's what's already implemented:

### 1. **Backend Implementation** ‚úÖ

#### Route: `POST /api/auth/google`

- **Location**: `src/routes/auth.routes.ts`
- **Controller**: `src/controllers/auth.controller.ts` - `googleSignIn` function
- **Service**: `src/services/auth.service.ts` - `verifyGoogleToken` and `findOrCreateUser`

#### What Happens When User Logs In:

1. Frontend sends Google ID token to backend
2. Backend verifies token with Google
3. Backend creates/updates user in MongoDB
4. Backend returns JWT tokens (access + refresh)
5. Frontend stores tokens and user data

---

## üìä MongoDB Data Structure

### Collection: `users`

When a user signs in with Google, the following document is created/updated:

```javascript
{
  // Unique Identifiers
  userId: "550e8400-e29b-41d4-a716-446655440000", // UUID generated by backend
  googleId: "102837465940283746594", // Google's unique ID for the user

  // Authentication
  email: "user@gmail.com",
  emailVerified: true, // Always true for Google OAuth
  authMethod: "google", // Can be: "google", "email", or "both"
  password: null, // No password for Google-only users

  // Profile Information
  name: "John Doe",
  firstName: "John",
  lastName: "Doe",
  picture: "https://lh3.googleusercontent.com/a/...", // Google profile photo
  phone: null, // Optional - can be added later

  // User Preferences
  preferences: {
    theme: "light", // "light" or "dark"
    language: "en", // "en" or "hi"
    currency: "INR",
    riskProfile: "moderate", // "conservative", "moderate", "aggressive"
    notifications: {
      email: true,
      push: true,
      priceAlerts: true,
      newsAlerts: true
    }
  },

  // KYC Status
  kyc: {
    status: "pending", // "pending", "verified", "rejected"
    panNumber: null, // Optional
    aadharNumber: null, // Optional
    verifiedAt: null // Date when KYC was verified
  },

  // Subscription
  subscription: {
    plan: "free", // "free", "basic", "premium"
    startDate: null,
    endDate: null,
    autoRenew: false
  },

  // Security & Session Management
  refreshTokens: [
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // JWT refresh tokens (last 5)
  ],
  lastLogin: ISODate("2025-12-03T10:30:00.000Z"),
  loginHistory: [
    {
      timestamp: ISODate("2025-12-03T10:30:00.000Z"),
      ip: "192.168.1.100",
      userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64)..."
    }
  ],

  // Account Status
  isActive: true,
  isBlocked: false,

  // Timestamps
  createdAt: ISODate("2025-12-03T10:30:00.000Z"),
  updatedAt: ISODate("2025-12-03T10:30:00.000Z")
}
```

---

## üéØ Technologies Used

### Backend:

1. **google-auth-library** - Verifies Google ID tokens
2. **jsonwebtoken** - Generates JWT access and refresh tokens
3. **bcrypt** - Password hashing (for email/password auth)
4. **MongoDB** - Stores user data
5. **Express.js** - Web framework
6. **TypeScript** - Type-safe code

### Frontend (Required):

1. **@react-oauth/google** - Official Google OAuth React library
2. **axios** - HTTP requests to backend

---

## üöÄ Frontend Integration Code

### Step 1: Install Dependencies

```bash
npm install @react-oauth/google axios
```

### Step 2: Wrap Your App with GoogleOAuthProvider

**For React (Vite/CRA):**

```jsx
// main.jsx or App.jsx
import { GoogleOAuthProvider } from '@react-oauth/google';

const GOOGLE_CLIENT_ID =
  'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

function App() {
  return (
    <GoogleOAuthProvider clientId={GOOGLE_CLIENT_ID}>
      {/* Your app components */}
      <Router>
        <Routes>
          <Route path="/login" element={<LoginPage />} />
          {/* ... other routes */}
        </Routes>
      </Router>
    </GoogleOAuthProvider>
  );
}

export default App;
```

**For Next.js:**

```jsx
// app/layout.js or _app.js
'use client';

import { GoogleOAuthProvider } from '@react-oauth/google';

const GOOGLE_CLIENT_ID =
  'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <GoogleOAuthProvider clientId={GOOGLE_CLIENT_ID}>
          {children}
        </GoogleOAuthProvider>
      </body>
    </html>
  );
}
```

### Step 3: Create Login Component

```jsx
// components/GoogleLoginButton.jsx
import { GoogleLogin } from '@react-oauth/google';
import axios from 'axios';
import { useNavigate } from 'react-router-dom'; // or next/navigation for Next.js

const BACKEND_URL = 'http://localhost:3002'; // Change for production

function GoogleLoginButton() {
  const navigate = useNavigate();

  const handleGoogleSuccess = async (credentialResponse) => {
    try {
      console.log('Google login success, sending to backend...');

      // Send ID token to backend
      const response = await axios.post(`${BACKEND_URL}/api/auth/google`, {
        idToken: credentialResponse.credential,
      });

      console.log('Backend response:', response.data);

      // Extract data from response
      const { user, tokens } = response.data.data;

      // Store in localStorage
      localStorage.setItem('accessToken', tokens.accessToken);
      localStorage.setItem('refreshToken', tokens.refreshToken);
      localStorage.setItem('user', JSON.stringify(user));

      // Show success message
      alert(`Welcome ${user.name}! Login successful.`);

      // Redirect to home/dashboard
      navigate('/'); // or navigate('/dashboard')

      // Optional: Reload to update auth state
      window.location.reload();
    } catch (error) {
      console.error('Login failed:', error);

      if (error.response) {
        // Backend error
        alert(`Login failed: ${error.response.data.error || 'Unknown error'}`);
      } else if (error.request) {
        // Network error
        alert('Cannot connect to server. Please check if backend is running.');
      } else {
        // Other error
        alert('An error occurred during login.');
      }
    }
  };

  const handleGoogleError = () => {
    console.error('Google login failed');
    alert('Google login failed. Please try again.');
  };

  return (
    <div style={{ display: 'flex', justifyContent: 'center', padding: '20px' }}>
      <GoogleLogin
        onSuccess={handleGoogleSuccess}
        onError={handleGoogleError}
        useOneTap
        theme="filled_blue"
        size="large"
        text="signin_with"
        shape="rectangular"
      />
    </div>
  );
}

export default GoogleLoginButton;
```

### Step 4: Use in Your Login Page

```jsx
// pages/LoginPage.jsx
import GoogleLoginButton from '../components/GoogleLoginButton';

function LoginPage() {
  return (
    <div
      style={{
        minHeight: '100vh',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '20px',
      }}
    >
      <h1>Login to Mutual Funds Platform</h1>

      <GoogleLoginButton />

      <p style={{ color: '#666', marginTop: '20px' }}>
        Or use email/password login
      </p>

      {/* Your email/password login form */}
    </div>
  );
}

export default LoginPage;
```

### Step 5: Create Auth Hook (Optional but Recommended)

```jsx
// hooks/useAuth.js
import { useState, useEffect } from 'react';

export function useAuth() {
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check if user is logged in
    const accessToken = localStorage.getItem('accessToken');
    const userStr = localStorage.getItem('user');

    if (accessToken && userStr) {
      try {
        const userData = JSON.parse(userStr);
        setUser(userData);
        setIsAuthenticated(true);
      } catch (error) {
        console.error('Failed to parse user data:', error);
        logout();
      }
    }

    setLoading(false);
  }, []);

  const logout = () => {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('user');
    setUser(null);
    setIsAuthenticated(false);
  };

  return { user, isAuthenticated, loading, logout };
}
```

### Step 6: Protected Route Component

```jsx
// components/ProtectedRoute.jsx
import { Navigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';

function ProtectedRoute({ children }) {
  const { isAuthenticated, loading } = useAuth();

  if (loading) {
    return <div>Loading...</div>;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return children;
}

export default ProtectedRoute;
```

---

## üß™ How to Test

### 1. Start Backend

```bash
cd e:\mutual-funds-backend
npm run dev
```

### 2. Start Frontend

```bash
cd path/to/your/frontend
npm run dev
```

### 3. Test the Flow

1. Go to login page
2. Click "Sign in with Google" button
3. Select your Google account
4. Check browser console for logs
5. Check if you're redirected to home page
6. Check localStorage for tokens and user data

### 4. Verify in MongoDB

```bash
# Connect to MongoDB
mongosh "mongodb+srv://rakeshd01042024_db_user:Rakesh1234@mutualfunds.l7zeno9.mongodb.net/"

# Switch to database
use test

# Find users
db.users.find().pretty()

# Find user by email
db.users.findOne({ email: "your-email@gmail.com" })

# Count Google users
db.users.countDocuments({ authMethod: "google" })
```

---

## üîß Troubleshooting

### Problem: "Google token verification failed"

**Cause**: Invalid or expired ID token

**Solution**: Make sure you're sending `credentialResponse.credential` (not the entire response)

---

### Problem: "Backend is not responding"

**Cause**: Backend server not running or wrong URL

**Solution**:

1. Check if backend is running on port 3002
2. Update BACKEND_URL in frontend code
3. Check CORS settings in backend

---

### Problem: "User not appearing in database"

**Cause**: Database connection issue or code not saving user

**Solution**:

1. Check MongoDB connection string in `.env`
2. Check backend terminal for errors
3. Make sure MongoDB is accessible

---

### Problem: CORS errors

**Cause**: Frontend origin not allowed

**Solution**: Add your frontend URL to CORS whitelist in `src/app.ts`:

```typescript
cors({
  origin: [
    'http://localhost:5001',
    'http://localhost:3000', // Add your frontend URL
    'https://your-frontend.vercel.app',
  ],
  credentials: true,
});
```

---

## üìù What Gets Stored in MongoDB - Summary

| Field           | Description               | Example                                     |
| --------------- | ------------------------- | ------------------------------------------- |
| `userId`        | Unique user ID (UUID)     | `550e8400-e29b-41d4-a716-446655440000`      |
| `googleId`      | Google's unique ID        | `102837465940283746594`                     |
| `email`         | User's email              | `user@gmail.com`                            |
| `emailVerified` | Email verification status | `true`                                      |
| `authMethod`    | Authentication method     | `"google"`                                  |
| `name`          | Full name                 | `"John Doe"`                                |
| `firstName`     | First name                | `"John"`                                    |
| `lastName`      | Last name                 | `"Doe"`                                     |
| `picture`       | Profile photo URL         | `"https://lh3.googleusercontent.com/a/..."` |
| `preferences`   | User preferences          | `{ theme: "light", language: "en", ... }`   |
| `kyc`           | KYC status                | `{ status: "pending" }`                     |
| `subscription`  | Subscription plan         | `{ plan: "free" }`                          |
| `refreshTokens` | JWT refresh tokens        | `["eyJhbGci..."]`                           |
| `lastLogin`     | Last login timestamp      | `ISODate("2025-12-03T10:30:00.000Z")`       |
| `loginHistory`  | Login history array       | `[{ timestamp, ip, userAgent }]`            |
| `isActive`      | Account active status     | `true`                                      |
| `createdAt`     | Account creation date     | `ISODate("2025-12-03T10:30:00.000Z")`       |

---

## ‚úÖ Summary

Your backend is **fully functional** for Google OAuth! You just need to:

1. ‚úÖ **Backend**: Already implemented and configured
2. ‚úÖ **MongoDB**: Schema is correct, data will be stored properly
3. üîß **Frontend**: Use the code above to integrate
4. ‚úÖ **Environment**: Google credentials are configured

**Technologies Used:**

- Backend: Express.js, TypeScript, MongoDB, google-auth-library, jsonwebtoken
- Frontend: React, @react-oauth/google, axios

The issue is likely on the **frontend side** - either:

- Google OAuth library not installed
- Wrong implementation of Google Sign-In button
- Not sending ID token to backend correctly

Use the code examples above and you should be good to go! üöÄ
